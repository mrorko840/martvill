"use strict";$(function(){function a(a,b={},c={}){let{defaults:d,data:e}={defaults:{type:"get",dataType:"json",processData:!1,contentType:!1,success:void 0,failed:z,complete:void 0,callbackParam:!1,formData:!1},data:{_token:token}};d=Object.assign({},d,c),e=d.formData?d.formData:Object.assign({},e,b),$.ajax({url:a,type:d.type,processData:d.processData,contentType:d.contentType,data:e,success:function(a){d.success&&d.success(d.callbackParam,a.response)},error:function(a,b,c){d.failed?d.failed(a,b,c):z(a,b,c)},complete:function(a,b){d.complete&&d.complete(a,b)}})}var b,c,d=$(".chat-view-container");let e=new Date().getTime();var f="";const g=()=>{window.clearTimeout(c),c=setTimeout(function(){w()},15e3)},h=()=>10<(new Date().getTime()-e)/1e3;$(document).on("click keyup","#message-to-send",function(){i()});const i=()=>{e=new Date().getTime()};("undefined"==typeof userLoggedIn||!0==userLoggedIn)&&setTimeout(()=>{g()},15e3),$(document).on("click",".chat-inbox-sidebar-toggle",function(){$(".chat-view-sidebar").toggleClass("chat-header-sidebar-mobile")}),$(document).on("keyup",".chat-sidebar-topbar-input",function(){var a=$(this).val();d.find(".chat-sidebar-user-name").filter(function(){$(this).closest(".chat-sidebar-user").toggle(-1<$(this).text().toLowerCase().indexOf(a))})}),$(document).on("click",".chat-toggle-button",function(){$(this).toggleClass("chat-hidden"),$(".chat-view-container").toggleClass("chat-hidden")}),$(document).on("click",".chat-view-close-button",function(){$(".chat-toggle-button").trigger("click")}),$(document).on("click",".chat-sidebar-user",function(){j($(this))});const j=b=>{let c=$(b).data("url");f=$("#message-to-send").val(),r(b),m(),a(c,{},{success:p,complete:n})},k=()=>{$(".chat-view-container").addClass("message-state-loading"),$("#message_form").find("input,textarea").prop("disabled",!0)},l=()=>{$(".chat-view-container").removeClass("message-state-loading"),$("#message_form").find("input").prop("disabled",!1)},m=()=>{$(".chat-view-container").addClass("chat-inbox-refreshing")},n=()=>{$(".chat-view-container").removeClass("chat-inbox-refreshing")},o=(a=100)=>{setTimeout(()=>{let a=$(".chat-inbox-body");a.scrollTop(a.prop("scrollHeight"))},a)},p=(a,b)=>{f=$("#message-to-send").val(),q(b.records.html),$(document).on("#chat-history-list","scroll",function(){0===$(this).scrollTop()&&lazyLoadInitiate($(this))}),$("#message-to-send").val(f),$("#message-to-send").trigger("focus"),f="",o()},q=a=>{$(".chat-view-body").find(".chat-view-inbox").remove(),$(".chat-view-body").append(a)},r=a=>{$(".chat-sidebar-user").removeClass("chat-user-active"),$(a).removeClass("chat-inbox-unread"),$(a).addClass("chat-user-active")};$(document).on("click","#chat-initiate-vendor",function(){$(".chat-toggle-button").hasClass("chat-hidden")||$(".chat-toggle-button").trigger("click"),a($(this).data("vendor"),{},{success:s})});const s=(a,b)=>{g(),$("body").trigger("chat-count-refreshed",[b.records.unread]),d.find(".chat-view-sidebar .chat-sidebar-users").remove(),d.find(".chat-view-sidebar").append(b.records.users),q(b.records.box),$(document).on("#chat-history-list","scroll",function(){0===$(this).scrollTop()&&lazyLoadInitiate($(this))}),o()};$(document).on("click",".send-item-message",function(){$(".chat-toggle-button").hasClass("chat-hidden")||$(".chat-toggle-button").trigger("click"),a($(this).data("vendor"),{},{success:t})});const t=(a,b)=>{$(".chat-sidebar-users").remove(),$(".chat-view-sidebar").append(b.records.users),$(".chat-view-inbox").remove(),$(".chat-view-body").append(b.records.html),d.find(".chat-user-active .chat-sidebar-user-text").html(jsLang("You")+": "+jsLang("Product sent.")),o(100)};$(document).on("keyup","#message-to-send",function(a){13!==a.keyCode||a.shiftKey||$("#message-form").trigger("submit")}),$(document).on("click",".chat-inbox-send-button",function(){$("#message-form").trigger("submit")}),$(document).on("submit","#message-form",function(c){c.preventDefault(),b=new FormData($(this)[0]);let d=filterXSS($("#message-to-send").val().trim()),e=$("#attachment-msg").val().trim();(d||e)&&(b.append("_token",token),b.append("thread_id",$(".chat-identifier").val()),$("#message-to-send").val(""),$(this).trigger("reset"),k(),a($(this).attr("action"),{},{success:u,failed:v,type:"post",formData:b,callbackParam:{message:d??e}}))}),$(document).on("change","#attachment-msg",function(){$("#message-to-send").val($(this)[0].files[0].name),$("#message-form").trigger("submit")});const u=(a,b)=>{l(),d.find(".chat-inbox-message-list").append(b.records.html),d.find(".chat-user-active .chat-sidebar-user-text").html(jsLang("You")+": "+a.message),o()},v=a=>{l();let b=JSON.parse(a.responseText),c=[],d="";if(b?.errors==null)d=`<li>${jsLang("Attachment failed")}</li>`;else{for(let a in b?.errors)Array.isArray(b.errors[a])&&c.push(...b.errors[a]);c.forEach(a=>{d+=`<li>${a}</li>`})}$(".chat-error-message ul").html(d),$(".chat-error-message").addClass("chat-error-show"),setTimeout(()=>{$(".chat-error-message").removeClass("chat-error-show"),$(".chat-error-message ul").html("")},4e3)};$(document).on("click",".chat-inbox-sidebar-reload",function(){w(!0)});const w=(b=!1)=>{const c=$(".chat-sidebar-user.chat-user-active");if(!b&&(document.hidden||!h()))return void g();let e={cid:c.attr("id")};m(),a(d.data("refreshurl")+`?cid=${e.cid}`,e,{success:x,failed:y,complete:n})},x=(a,b)=>{$("body").trigger("chat-count-refreshed",[b.records.unread]),d.find(".chat-view-sidebar .chat-sidebar-users").remove(),d.find(".chat-view-sidebar").append(b.records.users);let c=$(".chat-sidebar-user.chat-user-active").attr("id");c&&(d.hasClass("chat-hidden")?d.find(`#${c}`).addClass("chat-user-active"):d.find(`#${c}`).trigger("click")),g()};$(document).on("chat-count-refreshed","body",function(a,b){let c=$(".chat-sidebar-user.chat-inbox-unread").length;c=Math.max(c,b),0<c?$(".chat-unread-count").html(c).addClass("d-flex").removeClass("d-none"):$(".chat-unread-count").html("0").addClass("d-none").removeClass("d-flex")}),$(document).on("chat-users-refreshed","body",function(a,b){d.find(".chat-view-sidebar .chat-sidebar-users").remove(),d.find(".chat-view-sidebar").append(b)});const y=(a,b)=>{"Unauthenticated"==b?.message&&window.clearTimeout(c),g()},z=(a,b,c)=>{throw f="",c}});
